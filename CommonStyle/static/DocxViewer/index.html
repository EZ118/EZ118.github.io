<!DOCTYPE html>
<html><head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
		<link href="./manifest.json" rel="manifest">
		<link href="./icon.png" rel="shortcut icon">
		<link href="./icon.png" rel="icon">
		<link href="./style.css" rel="stylesheet">
		<title>Docx Viewer</title>

		<script src="./docx2html.min.js"></script>
	</head>
	<body>
		<!--Word Logo-->
		<img src="./icon.png" class="TitleBarIcon">
		
		<!--Title Bar-->
		<table class="TitleBar"><tbody><tr>
			<td width="35px"></td>
			<td align="left"><label>Word</label></td>
			<td align="right">
				<label style="color:rgba(200, 200, 200, 0.3);">
					Drop Or Click To Open
				</label>
			</td>
		</tr></tbody></table>
		
		<!--文件拖拽框-->
		<input type="file" style="display:none;" id="SelectFileBtn" onchange="docx2h5(this)"/>
		<div id="OneDrag" onclick="document.getElementById('SelectFileBtn').click()"></div>
		
		<center>
			<div id="container" style="display:none;"></div><!--文档显示容器-->
		</center>
		
		<script type="text/javascript">
			OneDrag = document.getElementById("OneDrag");
			Container = document.getElementById("container");
			WebTitle = document.getElementsByTagName("title")[0];
			
			function docx2h5(input){
				Container.innerHTML = "";
				require("docx2html")(input.files[0],{container:document.getElementById("container")})
					.then(html=>{
						Container.setAttribute("style", "display:block;");
						OneDrag.setAttribute("style", "background:rgba(200, 200, 200, 0.0);");
					});
			}
			
			
			OneDrag.ondragover = function(e) {
				//拖拽文件未释放
				e.preventDefault();
				OneDrag.setAttribute("style", "background:rgba(200, 200, 200, 0.5);");
			}
			
			OneDrag.ondrop = function(e) {
				//拖拽文件并释放
				e.preventDefault();
				OneDrag.setAttribute("style", "background:rgba(200, 200, 200, 0.0);");
				
				WebTitle.innerText = "文稿 - " + e.dataTransfer.files[0].name;
				docx2h5(e.dataTransfer);
			}
			
			OneDrag.ondragleave = function () {
				//拖拽文件后未释放，同时离开检测区
				OneDrag.setAttribute("style", "background:rgba(200, 200, 200, 0.0);");
			}
		</script>
		
		
		<!--Service Worker-->
		<script>
			if ('serviceWorker' in navigator) {
				window.addEventListener('load', function () {
					navigator.serviceWorker.register('./sw.js')
					.then(function (registration) {
						console.log('ServiceWorker registration successful with scope: ', registration.scope);
					})
					.catch(function (err) {
						console.log('ServiceWorker registration failed: ', err);
					});
				});
			}
		</script>
		
		
		<!--PWA File Handle API-->
		<script>		
		if ('launchQueue' in window) {
			window.launchQueue.setConsumer(async launchParams => {
				if (launchParams.files.length) {
					const fileHandles = launchParams.files;
					fileHandles.map(handle => console.log(handle.name));
					docx2h5(launchParams);
					/*
					* fileHandles is now an array of SystemFileHandles
					* https://wicg.github.io/file-system-access/#api-filesystemfilehandle
					*/
				}
			});
		}
		</script>
		
		<script>
		function GetUrlData() {
			let a = window.location.href + "#";
			a = a.split("#"); 
			return a[1];
		}
		window.onload = function() {
			if(GetUrlData() == "OD") {
				OneDrag.setAttribute("style", "height: 100%;");
			} else if(GetUrlData() == "OIB") {
				window.open(window.location.href.replace("#OIB", ""));
				window.close();
			}
		}
		</script>
</body></html>